---

- name: ensure local settings file is present
  become: yes
  become_method: su
  template:
    src=local-settings.j2
    dest={{ sites_directory }}/{{ site_name }}/application/shared/default/local-settings.inc
    owner={{ file_owner }}
    group={{ file_group }}
    mode=0444
  tags:
    - deploy

- name: get latest application repo
  git:
    dest={{ sites_directory }}/{{ site_name }}/application/shared/repository
    depth=1
    version={{ git_branch }}
    accept_hostkey=yes
    force=yes
    repo=ssh://git@github.com/{{ git_org }}/{{ git_repo }}.git
  tags:
    - deploy

- name: provision settings file
  become: yes
  become_method: su
  command: mv {{ sites_directory }}/{{ site_name }}/application/shared/repository/{{ drupal_root }}/sites/default/settings.php {{ sites_directory }}/{{ site_name }}/application/shared/default/settings.php
  tags:
    - deploy

- name: set settings file permissions
  become: yes
  become_method: su
  file:
    path={{ sites_directory }}/{{ site_name }}/application/shared/default/settings.php
    owner={{ file_owner }}
    group={{ file_group }}
    mode=0444
    state=file
  tags:
    - deploy
